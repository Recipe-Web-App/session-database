apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "session-database.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "session-database.labels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  REDIS_HOST: {{ include "session-database.fullname" . }}-master-service
  REDIS_PORT: "6379"
  REDIS_DB: "0"
  SESSION_TTL_SECONDS: {{ .Values.sessionManagement.sessionTTL | quote }}
  REFRESH_TOKEN_TTL_SECONDS: {{ .Values.sessionManagement.refreshTokenTTL | quote }}
  MAX_SESSIONS_PER_USER: {{ .Values.sessionManagement.maxSessionsPerUser | quote }}
  MAX_REFRESH_TOKENS_PER_USER: {{ .Values.sessionManagement.maxRefreshTokensPerUser | quote }}
  CLEANUP_INTERVAL_SECONDS: "300"
  LOG_LEVEL: "INFO"
---
{{- if .Values.ha.sentinel.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "session-database.fullname" . }}-sentinel-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "session-database.sentinelLabels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  sentinel.conf: |
    port 26379
    sentinel monitor session-master {{ include "session-database.fullname" . }}-master-service 6379 2
    sentinel auth-pass session-master ${REDIS_PASSWORD}
    sentinel down-after-milliseconds session-master {{ .Values.ha.sentinel.downAfterMilliseconds }}
    sentinel parallel-syncs session-master {{ .Values.ha.sentinel.parallelSyncs }}
    sentinel failover-timeout session-master {{ .Values.ha.sentinel.failoverTimeout }}
    requirepass ${SENTINEL_PASSWORD}
    logfile /var/log/redis/sentinel.log
    loglevel notice
    bind 0.0.0.0
    protected-mode no
    sentinel announce-hostnames yes
    sentinel resolve-hostnames yes
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "session-database.fullname" . }}-master-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "session-database.masterLabels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  redis.conf: |
    port 6379
    bind 0.0.0.0
    protected-mode no
    requirepass ${REDIS_PASSWORD}
    masterauth ${REDIS_PASSWORD}
    maxmemory {{ .Values.redis.config.maxmemory }}
    maxmemory-policy {{ .Values.redis.config.maxmemoryPolicy }}
    save {{ .Values.redis.config.save }}
    stop-writes-on-bgsave-error yes
    rdbcompression yes
    rdbchecksum yes
    dbfilename dump.rdb
    dir /data
    appendonly {{ .Values.redis.config.appendonly }}
    appendfilename "appendonly.aof"
    appendfsync everysec
    no-appendfsync-on-rewrite no
    auto-aof-rewrite-percentage 100
    auto-aof-rewrite-min-size 64mb
    logfile /var/log/redis/redis.log
    loglevel notice
    tcp-keepalive {{ .Values.redis.config.tcpKeepalive }}
    timeout {{ .Values.redis.config.timeout }}
    tcp-backlog 511
    hash-max-ziplist-entries 512
    hash-max-ziplist-value 64
    list-max-ziplist-size -2
    list-compress-depth 0
    set-max-intset-entries 512
    zset-max-ziplist-entries 128
    zset-max-ziplist-value 64
    lua-time-limit 5000
    slowlog-log-slower-than 10000
    slowlog-max-len 128
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "session-database.fullname" . }}-replica-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "session-database.replicaLabels" . | nindent 4 }}
  {{- with .Values.commonAnnotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
data:
  redis.conf: |
    port 6379
    bind 0.0.0.0
    protected-mode no
    requirepass ${REDIS_PASSWORD}
    masterauth ${REDIS_PASSWORD}
    replicaof {{ include "session-database.fullname" . }}-master-service 6379
    replica-read-only yes
    replica-serve-stale-data yes
    replica-priority 100
    maxmemory {{ .Values.redis.config.maxmemory }}
    maxmemory-policy {{ .Values.redis.config.maxmemoryPolicy }}
    save ""
    appendonly no
    logfile /var/log/redis/redis-replica.log
    loglevel notice
    tcp-keepalive {{ .Values.redis.config.tcpKeepalive }}
    timeout {{ .Values.redis.config.timeout }}
    tcp-backlog 511
    lua-time-limit 5000
    slowlog-log-slower-than 10000
    slowlog-max-len 128
{{- end }}

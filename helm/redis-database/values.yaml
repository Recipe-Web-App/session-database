---
# Default values for redis-database
# Multi-service Redis infrastructure with per-service database isolation

# Global configuration
global:
  imageRegistry: ""
  storageClass: "standard"

# Image configuration
image:
  registry: ""
  repository: redis-database
  tag: "latest"
  pullPolicy: IfNotPresent
  pullSecrets: []

# Deployment mode: standalone, sentinel, cluster
deploymentMode: sentinel

# Sentinel configuration
sentinel:
  masterName: "redis-master"

# =============================================================================
# SERVICE DATABASE CONFIGURATION
# Each service gets its own database number (0-15) and ACL user
# =============================================================================
services:
  # Auth Service - OAuth2 authentication (DB 0)
  auth:
    enabled: true
    database: 0
    keyPrefix: "auth"
    description: "OAuth2 authentication service"
    ttl:
      session: 3600           # 1 hour
      accessToken: 900        # 15 minutes
      refreshToken: 604800    # 7 days
      authorizationCode: 600  # 10 minutes
    cleanup:
      enabled: true
      schedule: "*/5 * * * *"
      batchSize: 100

  # Recipe Scraper Service - 3 databases
  recipeScraper:
    cache:
      enabled: true
      database: 1
      keyPrefix: "scraper:cache"
      description: "Recipe scraper response cache"
      ttl:
        default: 86400  # 24 hours
      cleanup:
        enabled: true
        schedule: "*/10 * * * *"
        batchSize: 200
    queue:
      enabled: true
      database: 2
      keyPrefix: "scraper:queue"
      description: "Recipe scraper job queue"
    rateLimit:
      enabled: true
      database: 3
      keyPrefix: "scraper:ratelimit"
      description: "Recipe scraper rate limiting"
      ttl:
        window: 60  # 1 minute sliding window

  # User Management Service (DB 4)
  userManagement:
    enabled: true
    database: 4
    keyPrefix: "user"
    description: "User management service cache"
    ttl:
      default: 3600  # 1 hour
    cleanup:
      enabled: true
      schedule: "*/15 * * * *"
      batchSize: 100

  # Notification Service (DB 5)
  notification:
    enabled: true
    database: 5
    keyPrefix: "notification"
    description: "Notification service queue and state"
    ttl:
      default: 86400  # 24 hours

  # Meal Plan Management Service (DB 6)
  mealPlan:
    enabled: true
    database: 6
    keyPrefix: "mealplan"
    description: "Meal plan management cache"
    ttl:
      default: 86400  # 24 hours

# =============================================================================
# REDIS ACL SECURITY
# Per-service users with key pattern restrictions
# =============================================================================
redis:
  auth:
    enabled: true
    # Admin password (for ops/debugging) - full access
    password: "${REDIS_ADMIN_PASSWORD}"
    sentinel:
      password: "${SENTINEL_PASSWORD}"

  # ACL configuration for per-service isolation
  acl:
    enabled: true
    users:
      # Auth service user - DB 0, auth:* keys only
      auth:
        enabled: true
        password: "${AUTH_SERVICE_REDIS_PASSWORD}"
        keyPattern: "auth:*"
        commands: "+@all -@dangerous"
        database: 0

      # Recipe Scraper user - DBs 1-3, scraper:* keys only
      scraper:
        enabled: true
        password: "${SCRAPER_SERVICE_REDIS_PASSWORD}"
        keyPattern: "scraper:*"
        commands: "+@all -@dangerous"
        databases: [1, 2, 3]

      # User Management user - DB 4, user:* keys only
      user:
        enabled: true
        password: "${USER_SERVICE_REDIS_PASSWORD}"
        keyPattern: "user:*"
        commands: "+@all -@dangerous"
        database: 4

      # Notification Service user - DB 5, notification:* keys only
      notification:
        enabled: true
        password: "${NOTIFICATION_SERVICE_REDIS_PASSWORD}"
        keyPattern: "notification:*"
        commands: "+@all -@dangerous"
        database: 5

      # Meal Plan user - DB 6, mealplan:* keys only
      mealplan:
        enabled: true
        password: "${MEALPLAN_SERVICE_REDIS_PASSWORD}"
        keyPattern: "mealplan:*"
        commands: "+@all -@dangerous"
        database: 6

  # Redis server configuration
  config:
    maxmemory: "1gb"
    maxmemoryPolicy: "allkeys-lru"
    save: "900 1 300 10 60 10000"
    appendonly: true
    timeout: 300
    tcpKeepalive: 300

  # TLS configuration
  tls:
    enabled: false
    port: 6380

# =============================================================================
# HIGH AVAILABILITY CONFIGURATION
# =============================================================================
ha:
  # Redis Sentinel configuration
  sentinel:
    enabled: true
    replicas: 1
    downAfterMilliseconds: 5000
    failoverTimeout: 10000
    parallelSyncs: 1

    resources:
      requests:
        memory: "128Mi"
        cpu: "100m"
      limits:
        memory: "256Mi"
        cpu: "200m"

  # Redis Master configuration
  master:
    replicas: 1
    persistence:
      enabled: true
      size: "10Gi"
      storageClass: ""

    resources:
      requests:
        memory: "1Gi"
        cpu: "500m"
        ephemeralStorage: "2Gi"
      limits:
        memory: "2Gi"
        cpu: "1000m"
        ephemeralStorage: "4Gi"

  # Redis Replica configuration
  replica:
    replicas: 1
    persistence:
      enabled: false

    resources:
      requests:
        memory: "512Mi"
        cpu: "250m"
        ephemeralStorage: "1Gi"
      limits:
        memory: "1Gi"
        cpu: "500m"
        ephemeralStorage: "2Gi"

# =============================================================================
# CLEANUP JOB CONFIGURATION
# =============================================================================
cleanup:
  # Global cleanup settings
  resources:
    requests:
      memory: "32Mi"
      cpu: "10m"
    limits:
      memory: "64Mi"
      cpu: "50m"

# =============================================================================
# SECURITY CONFIGURATION
# =============================================================================
security:
  # Pod Security Standards
  podSecurityStandards:
    enabled: true
    enforce: "restricted"

  # Network Policies
  networkPolicies:
    enabled: true

    # Application namespace/labels that can access Redis
    applicationAccess:
      namespaceSelector:
        matchLabels:
          name: "default"
      podSelector:
        matchLabels:
          component: "application"

  # Service Accounts
  serviceAccount:
    create: true
    automountServiceAccountToken: false
    annotations: {}

# =============================================================================
# AUTOSCALING CONFIGURATION
# =============================================================================
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Node affinity and scheduling
affinity:
  podAntiAffinity: "preferred"
  nodeAffinity: {}

tolerations: []

nodeSelector: {}

# =============================================================================
# SERVICE CONFIGURATION
# =============================================================================
service:
  type: ClusterIP
  port: 6379
  targetPort: 6379
  annotations: {}

  # NodePort configuration (for local development)
  nodePort:
    enabled: false
    port: 30379

  # Sentinel service
  sentinel:
    type: ClusterIP
    port: 26379
    targetPort: 26379
    annotations: {}
    nodePort:
      enabled: false
      port: 30380

# =============================================================================
# INGRESS CONFIGURATION (for monitoring)
# =============================================================================
ingress:
  enabled: false
  className: ""
  annotations: {}
  prometheusHost: ""
  grafanaHost: ""
  tls: []

# =============================================================================
# ADDITIONAL CONFIGURATION
# =============================================================================

# Additional environment variables
extraEnvVars: []

# Additional volumes
extraVolumes: []

# Additional volume mounts
extraVolumeMounts: []

# Labels to add to all resources
commonLabels: {}

# Annotations to add to all resources
commonAnnotations: {}
